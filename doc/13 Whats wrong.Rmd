---
title: "13 What's wrong with p-values?"
output:
  html_document:
    css: tabbed_notebook.css
    fig_width: 3
    fig_height: 3
params: 
  output_dir: "../output"
---

```{r setup, echo=FALSE}
root <- "13_whats_wrong"
source("../R/setup.R")
library(boot)
library(pwr)
library(parallel)
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  cache = TRUE,
  cache.path = paste0("../cache/", root),
  fig.path = paste0("../cache/", root)
)
fig <- paste0("../fig/", root, "/")
if(!dir.exists(fig)) dir.create(fig)
```

```{css echo=FALSE}
pre code, pre, code {
  white-space: pre !important;
  overflow-x: scroll !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}
```

```{r effect_palette}
efPalette <- c("lightgoldenrod3", "#009E73")
```


```{r two_dist_plot_function}
plotTwoDist <- function(d1, d2, breaks, alpha=0.8, ymax=1) {
  g <- ggplot() +
    theme_classic() +
    theme(
      legend.position = "none",
      axis.line.y = element_blank(),
      axis.ticks.y = element_blank(),
      axis.text.y = element_blank(),
      axis.title.y = element_blank()
    ) +
    labs(x="Body mass (g)", y=NULL) +
    scale_y_continuous(expand=c(0,0), limits=c(0, ymax))
  g <- g +
    geom_histogram(aes(x=x), data=data.frame(x=d1), fill=efPalette[1], breaks=breaks, alpha=alpha) +
    geom_outline(d1, breaks, y.value="count", colour="grey40", alpha=alpha)+
    geom_histogram(aes(x=x), data=data.frame(x=d2), fill=efPalette[2], breaks=breaks, alpha=alpha) +
    geom_outline(d2, breaks, y.value="count", colour="grey40", alpha=alpha)
}

plotTwoP <- function(p1, p2, x.lim=c(0, 1), bins=0.01, alpha=0.8, ymax=5, x.breaks=seq(0,1,0.2)) {
  d <- data.frame(
    sample = c(rep("B", length(p1)), rep("A", length(p2))),
    value = c(p1, p2)
  )
  brks <- seq(0, 1, bins)
  
  g <- ggplot() +
    theme_classic() +
    theme(
      legend.position = "none",
      plot.margin = margin(l=10, r=10, t=6)
    ) +
    labs(x="P-value", y=NULL) +
    scale_y_continuous(expand=c(0,0), limits=c(0, ymax)) +
    scale_fill_manual(values = efPalette[2:1]) +
    scale_x_continuous(breaks=x.breaks, expand=c(0,0)) +
    coord_cartesian(xlim=x.lim)
  g <- g +
    geom_histogram(data=d, aes(x=value, y=..count../(sum(..count..) * bins), fill=sample), breaks=brks, position="stack")
  g <- g + 
    #geom_outline(p1, brks, colour="grey40", alpha=alpha) +
    geom_outline(c(p1,p2), brks, colour="grey40", alpha=alpha)
}

```



```{r plot_two_samples_97_3}
set.seed(111)
d1 <- rnorm(97000, 20, 5)
d2 <- rnorm(3000, 30, 5)
brks <- seq(0, 50, 0.5)
g <- plotTwoDist(d1, d2, ymax=4000, breaks=brks)
g 

ggsave(paste0(fig, "mice_97_3.png"), plot=g, device="png", width=3, height=3, dpi=300)
```

```{r p-values_sampling_generate}
pSampling <- function(d, n=5, nsim=10000, mu=20) {
  p <- unlist(lapply(1:nsim, function(i) {
    t.test(sample(d, n), mu = mu)$p.value
  }))
}

p1 <- pSampling(d1, nsim=97000)
p2 <- pSampling(d2, nsim=3000)
```

```{r p-values_sampling}
g1 <- plotTwoP(p1, p2, ymax=5)
g1
 
g2 <- plotTwoP(p1, p2, ymax=5, x.lim=c(0, 0.05), bins=0.001, x.breaks=seq(0, 0.05, 0.01))
g2


ggsave(paste0(fig, "mice_p_97_3.png"), plot=g1, device="png", width=3, height=3, dpi=300)
ggsave(paste0(fig, "mice_p_97_3_zoom.png"), plot=g2, device="png", width=3, height=3, dpi=300)
```








```{r plot_two_samples_50_50}
set.seed(111)
d1.5 <- rnorm(50000, 20, 5)
d2.5 <- rnorm(50000, 30, 5)
brks <- seq(0, 50, 0.5)
g <- plotTwoDist(d1.5, d2.5, ymax=2200, breaks=brks, alpha=0.6)
g

ggsave(paste0(fig, "mice_50_50.png"), plot=g, device="png", width=3, height=3, dpi=300)
```

```{r p-values_sampling_generate_50_50}
set.seed(20)
p1.5 <- pSampling(d1.5, nsim=50000)
p2.5 <- pSampling(d2.5, nsim=50000)
```

```{r p-values_sampling_50_50}
g1 <- plotTwoP(p1.5, p2.5, ymax=60, x.lim=c(0, 0.05), bins=0.001, x.breaks=seq(0, 0.05, 0.01))
g1
 
g2 <- plotTwoP(p1.5, p2.5, ymax=3, x.lim=c(0.04, 0.06), bins=0.001, x.breaks=seq(0, 0.1, 0.005))
g2

ggsave(paste0(fig, "mice_p_50_50.png"), plot=g1, device="png", width=3, height=3, dpi=300)
ggsave(paste0(fig, "mice_p_50_50_zoom.png"), plot=g2, device="png", width=3, height=3, dpi=300)
```


```{r p_reliability_generate}
set.seed(991)
p.3 <- pSampling(rnorm(10000, 25, 5), n = 3, nsim=100000)
p.10 <- pSampling(rnorm(10000, 25, 5), n = 10, nsim=100000)
```

```{r plot_p_reliability}
g1 <- plotOneDist(p.3, "p-value", "", limits=c(0,1), fill=efPalette[2], with.outline = TRUE) +
  scale_x_continuous(expand=c(0,0), breaks=seq(0,1,0.2), labels=seq(0,1,0.2))
g2 <- plotOneDist(p.10, "p-value", "", limits=c(0,1), fill=efPalette[2], with.outline = TRUE) +
  scale_x_continuous(expand=c(0,0), breaks=seq(0,1,0.2), labels=seq(0,1,0.2))


g1
g2

ggsave(paste0(fig, "mice_p_full_3.png"), plot=g1, device="png", width=3, height=3, dpi=300)
ggsave(paste0(fig, "mice_p_full_10.png"), plot=g2, device="png", width=3, height=3, dpi=300)

```

